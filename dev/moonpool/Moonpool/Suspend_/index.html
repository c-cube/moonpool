<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Suspend_ (moonpool.Moonpool.Suspend_)</title><link rel="stylesheet" href="../../../_odoc-theme/odoc.css"/><meta charset="utf-8"/><meta name="generator" content="odoc 2.2.1"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body class="odoc"><nav class="odoc-nav"><a href="../index.html">Up</a> â€“ <a href="../../index.html">moonpool</a> &#x00BB; <a href="../index.html">Moonpool</a> &#x00BB; Suspend_</nav><header class="odoc-preamble"><h1>Module <code><span>Moonpool.Suspend_</span></code></h1><p>Suspensions.</p><p>This is only going to work on OCaml 5.x.</p><p><b>NOTE</b>: this is not stable for now.</p><ul class="at-tags"><li class="alert"><span class="at-tag">alert</span> unstable this module is an implementation detail of moonpool for now</li></ul><p>(Private) suspending tasks using Effects.</p><p>This module is an implementation detail of Moonpool and should not be used outside of it, except by experts to implement <a href="../Runner/index.html"><code>Runner</code></a>.</p></header><div class="odoc-content"><div class="odoc-spec"><div class="spec type anchored" id="type-suspension"><a href="#type-suspension" class="anchor"></a><code><span><span class="keyword">type</span> suspension</span><span> = <span><span><span>(unit, exn * <a href="../../../ocaml/Stdlib/Printexc/index.html#type-raw_backtrace">Stdlib.Printexc.raw_backtrace</a>)</span> <a href="../../../ocaml/Stdlib/index.html#type-result">result</a></span> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p>A suspended computation</p></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-task"><a href="#type-task" class="anchor"></a><code><span><span class="keyword">type</span> task</span><span> = <span>unit <span class="arrow">&#45;&gt;</span></span> unit</span></code></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-suspension_handler"><a href="#type-suspension_handler" class="anchor"></a><code><span><span class="keyword">type</span> suspension_handler</span><span> = </span><span>{</span></code><ol><li id="type-suspension_handler.handle" class="def record field anchored"><a href="#type-suspension_handler.handle" class="anchor"></a><code><span>handle : <span>run:<span>(<span>with_handler:bool <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-task">task</a> <span class="arrow">&#45;&gt;</span></span> unit)</span> <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-suspension">suspension</a> <span class="arrow">&#45;&gt;</span></span> unit;</span></code></li></ol><code><span>}</span></code></div><div class="spec-doc"><p>The handler that knows what to do with the suspended computation.</p><p>The handler is given two things:</p><ul><li>the suspended computation (which can be resumed with a result eventually);</li><li>a <code>run</code> function that can be used to start tasks to perform some computation.</li></ul><p>This means that a fork-join primitive, for example, can use a single call to <a href="#val-suspend"><code>suspend</code></a> to:</p><ul><li>suspend the caller until the fork-join is done</li><li>use <code>run</code> to start all the tasks. Typically <code>run</code> is called multiple times, which is where the &quot;fork&quot; part comes from. Each call to <code>run</code> potentially runs in parallel with the other calls. The calls must coordinate so that, once they are all done, the suspended caller is resumed with the aggregated result of the computation.</li></ul></div></div><div class="odoc-spec"><div class="spec type extension anchored" id="extension-decl-Suspend"><a href="#extension-decl-Suspend" class="anchor"></a><code><span><span class="keyword">type</span> <a href="../../../ocaml/Stdlib/Effect/index.html#type-t">Stdlib.Effect.t</a> += </span></code><ol><li id="extension-Suspend" class="def extension anchored"><a href="#extension-Suspend" class="anchor"></a><code><span>| </span><span><span class="extension">Suspend</span> : <a href="#type-suspension_handler">suspension_handler</a> <span class="arrow">&#45;&gt;</span> <span>unit <a href="../../../ocaml/Stdlib/Effect/index.html#type-t">Stdlib.Effect.t</a></span></span></code><div class="def-doc"><span class="comment-delim">(*</span><p>The effect used to suspend the current thread and pass it, suspended, to the handler. The handler will ensure that the suspension is resumed later once some computation has been done.</p><span class="comment-delim">*)</span></div></li></ol></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-suspend"><a href="#val-suspend" class="anchor"></a><code><span><span class="keyword">val</span> suspend : <span><a href="#type-suspension_handler">suspension_handler</a> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p><code>suspend h</code> jumps back to the nearest <a href="#val-with_suspend"><code>with_suspend</code></a> and calls <code>h.handle</code> with the current continuation <code>k</code> and a task runner function.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-with_suspend"><a href="#val-with_suspend" class="anchor"></a><code><span><span class="keyword">val</span> with_suspend : 
  <span>run:<span>(<span>with_handler:bool <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-task">task</a> <span class="arrow">&#45;&gt;</span></span> unit)</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span>(<span>unit <span class="arrow">&#45;&gt;</span></span> unit)</span> <span class="arrow">&#45;&gt;</span></span>
  unit</span></code></div><div class="spec-doc"><p><code>with_suspend ~run f</code> runs <code>f()</code> in an environment where <code>suspend</code> will work. If <code>f()</code> suspends with suspension handler <code>h</code>, this calls <code>h ~run k</code> where <code>k</code> is the suspension.</p><p>This will not do anything on OCaml 4.x.</p></div></div></div></body></html>