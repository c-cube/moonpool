<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Fork_join (moonpool.Moonpool.Fork_join)</title><meta charset="utf-8"/><link rel="stylesheet" href="../../../_odoc-theme/odoc.css"/><meta name="generator" content="odoc 2.4.1"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body class="odoc"><nav class="odoc-nav"><a href="../index.html">Up</a> – <a href="../../index.html">moonpool</a> &#x00BB; <a href="../index.html">Moonpool</a> &#x00BB; Fork_join</nav><header class="odoc-preamble"><h1>Module <code><span>Moonpool.Fork_join</span></code></h1><p>Fork-join primitives.</p><p><b>NOTE</b> These are only available on OCaml 5.0 and above.</p><ul class="at-tags"><li class="since"><span class="at-tag">since</span> 0.3</li></ul></header><div class="odoc-content"><div class="odoc-spec"><div class="spec value anchored" id="val-both"><a href="#val-both" class="anchor"></a><code><span><span class="keyword">val</span> both : <span><span>(<span>unit <span class="arrow">&#45;&gt;</span></span> <span class="type-var">'a</span>)</span> <span class="arrow">&#45;&gt;</span></span> <span><span>(<span>unit <span class="arrow">&#45;&gt;</span></span> <span class="type-var">'b</span>)</span> <span class="arrow">&#45;&gt;</span></span> <span class="type-var">'a</span> * <span class="type-var">'b</span></span></code></div><div class="spec-doc"><p><code>both f g</code> runs <code>f()</code> and <code>g()</code>, potentially in parallel, and returns their result when both are done. If any of <code>f()</code> and <code>g()</code> fails, then the whole computation fails.</p><p>This must be run from within the pool: for example, inside <code>Pool.run</code> or inside a <a href="../Fut/index.html#val-spawn"><code>Fut.spawn</code></a> computation. This is because it relies on an effect handler to be installed.</p><ul class="at-tags"><li class="since"><span class="at-tag">since</span> 0.3</li></ul><p><b>NOTE</b> this is only available on OCaml 5.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-both_ignore"><a href="#val-both_ignore" class="anchor"></a><code><span><span class="keyword">val</span> both_ignore : <span><span>(<span>unit <span class="arrow">&#45;&gt;</span></span> <span class="type-var">_</span>)</span> <span class="arrow">&#45;&gt;</span></span> <span><span>(<span>unit <span class="arrow">&#45;&gt;</span></span> <span class="type-var">_</span>)</span> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p>Same as <code>both f g |&gt; ignore</code>.</p><ul class="at-tags"><li class="since"><span class="at-tag">since</span> 0.3</li></ul><p><b>NOTE</b> this is only available on OCaml 5.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-for_"><a href="#val-for_" class="anchor"></a><code><span><span class="keyword">val</span> for_ : <span><span class="optlabel">?chunk_size</span>:int <span class="arrow">&#45;&gt;</span></span> <span>int <span class="arrow">&#45;&gt;</span></span> <span><span>(<span>int <span class="arrow">&#45;&gt;</span></span> <span>int <span class="arrow">&#45;&gt;</span></span> unit)</span> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p><code>for_ n f</code> is the parallel version of <code>for i=0 to n-1 do f i done</code>.</p><p><code>f</code> is called with parameters <code>low</code> and <code>high</code> and must use them like so:</p><pre class="language-ocaml"><code>for j = low to high do (* … actual work *) done </code></pre><p>. If <code>chunk_size=1</code> then <code>low=high</code> and the loop is not actually needed.</p><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">chunk_size</span> <p>controls the granularity of parallelism. The default chunk size is not specified. See <a href="#val-all_array"><code>all_array</code></a> or <a href="#val-all_list"><code>all_list</code></a> for more details.</p><p>Example:</p><pre class="language-ocaml"><code>let total_sum = Atomic.make 0

let() = for_ ~chunk_size:5 100
  (fun low high -&gt;
    (* iterate on the range sequentially. The range should have 5 items or less. *)
    let local_sum = ref 0 in
    for j=low to high do
      local_sum := !local_sum + j
    done;
    ignore (Atomic.fetch_and_add total_sum !local_sum : int)))

let() = assert (Atomic.get total_sum = 4950)</code></pre><p>Note how we still compute a local sum sequentially in <code>(fun low high -&gt; …)</code>, before combining it wholesale into <code>total_sum</code>. When the chunk size is large, this can have a dramatic impact on the synchronization overhead.</p><p>When <code>chunk_size</code> is not provided, the library will attempt to guess a value that keeps all cores busy but runs as few tasks as possible to reduce the synchronization overhead.</p><p>Use <code>~chunk_size:1</code> if you explicitly want to run each iteration of the loop in its own task.</p></li></ul><ul class="at-tags"><li class="since"><span class="at-tag">since</span> 0.3</li></ul><p><b>NOTE</b> this is only available on OCaml 5.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-all_array"><a href="#val-all_array" class="anchor"></a><code><span><span class="keyword">val</span> all_array : <span><span class="optlabel">?chunk_size</span>:int <span class="arrow">&#45;&gt;</span></span> <span><span><span>(<span>unit <span class="arrow">&#45;&gt;</span></span> <span class="type-var">'a</span>)</span> array</span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'a</span> array</span></span></code></div><div class="spec-doc"><p><code>all_array fs</code> runs all functions in <code>fs</code> in tasks, and waits for all the results.</p><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">chunk_size</span> <p>if equal to <code>n</code>, groups items by <code>n</code> to be run in a single task. Default is <code>1</code>.</p></li></ul><ul class="at-tags"><li class="since"><span class="at-tag">since</span> 0.3</li></ul><p><b>NOTE</b> this is only available on OCaml 5.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-all_list"><a href="#val-all_list" class="anchor"></a><code><span><span class="keyword">val</span> all_list : <span><span class="optlabel">?chunk_size</span>:int <span class="arrow">&#45;&gt;</span></span> <span><span><span>(<span>unit <span class="arrow">&#45;&gt;</span></span> <span class="type-var">'a</span>)</span> list</span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'a</span> list</span></span></code></div><div class="spec-doc"><p><code>all_list fs</code> runs all functions in <code>fs</code> in tasks, and waits for all the results.</p><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">chunk_size</span> <p>if equal to <code>n</code>, groups items by <code>n</code> to be run in a single task. Default is not specified. This parameter is available since 0.3.</p></li></ul><ul class="at-tags"><li class="since"><span class="at-tag">since</span> 0.3</li></ul><p><b>NOTE</b> this is only available on OCaml 5.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-all_init"><a href="#val-all_init" class="anchor"></a><code><span><span class="keyword">val</span> all_init : <span><span class="optlabel">?chunk_size</span>:int <span class="arrow">&#45;&gt;</span></span> <span>int <span class="arrow">&#45;&gt;</span></span> <span><span>(<span>int <span class="arrow">&#45;&gt;</span></span> <span class="type-var">'a</span>)</span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'a</span> list</span></span></code></div><div class="spec-doc"><p><code>all_init n f</code> runs functions <code>f 0</code>, <code>f 1</code>, … <code>f (n-1)</code> in tasks, and waits for all the results.</p><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">chunk_size</span> <p>if equal to <code>n</code>, groups items by <code>n</code> to be run in a single task. Default is not specified. This parameter is available since 0.3.</p></li></ul><ul class="at-tags"><li class="since"><span class="at-tag">since</span> 0.3</li></ul><p><b>NOTE</b> this is only available on OCaml 5.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-map_array"><a href="#val-map_array" class="anchor"></a><code><span><span class="keyword">val</span> map_array : <span><span class="optlabel">?chunk_size</span>:int <span class="arrow">&#45;&gt;</span></span> <span><span>(<span><span class="type-var">'a</span> <span class="arrow">&#45;&gt;</span></span> <span class="type-var">'b</span>)</span> <span class="arrow">&#45;&gt;</span></span> <span><span><span class="type-var">'a</span> array</span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'b</span> array</span></span></code></div><div class="spec-doc"><p><code>map_array f arr</code> is like <code>Array.map f arr</code>, but runs in parallel.</p><ul class="at-tags"><li class="since"><span class="at-tag">since</span> 0.3</li></ul><p><b>NOTE</b> this is only available on OCaml 5.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-map_list"><a href="#val-map_list" class="anchor"></a><code><span><span class="keyword">val</span> map_list : <span><span class="optlabel">?chunk_size</span>:int <span class="arrow">&#45;&gt;</span></span> <span><span>(<span><span class="type-var">'a</span> <span class="arrow">&#45;&gt;</span></span> <span class="type-var">'b</span>)</span> <span class="arrow">&#45;&gt;</span></span> <span><span><span class="type-var">'a</span> list</span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'b</span> list</span></span></code></div><div class="spec-doc"><p><code>map_list f l</code> is like <code>List.map f l</code>, but runs in parallel.</p><ul class="at-tags"><li class="since"><span class="at-tag">since</span> 0.3</li></ul><p><b>NOTE</b> this is only available on OCaml 5.</p></div></div></div></body></html>
