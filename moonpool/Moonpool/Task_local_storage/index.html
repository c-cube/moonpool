<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Task_local_storage (moonpool.Moonpool.Task_local_storage)</title><meta charset="utf-8"/><link rel="stylesheet" href="../../../_odoc-theme/odoc.css"/><meta name="generator" content="odoc 3.1.0"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body class="odoc"><nav class="odoc-nav"><a href="../index.html">Up</a> â€“ <a href="../../../index.html">Index</a> &#x00BB; <a href="../../index.html">moonpool</a> &#x00BB; <a href="../index.html">Moonpool</a> &#x00BB; Task_local_storage</nav><header class="odoc-preamble"><h1>Module <code><span>Moonpool.Task_local_storage</span></code></h1><p>Task-local storage.</p><p>This storage is associated to the current task, just like thread-local storage is associated with the current thread. The storage is carried along in case the current task is suspended.</p><ul class="at-tags"><li class="since"><span class="at-tag">since</span> 0.6</li></ul></header><div class="odoc-tocs"><nav class="odoc-toc odoc-local-toc"><ul><li><a href="#local-hmap.t">Local <code>Hmap.t</code></a></li></ul></nav></div><div class="odoc-content"><div class="odoc-spec"><div class="spec type anchored" id="type-t"><a href="#type-t" class="anchor"></a><code><span><span class="keyword">type</span> <span>'a t</span></span><span> = <span><span class="type-var">'a</span> <a href="../../../picos/Picos/Fiber/FLS/index.html#type-t">Picos.Fiber.FLS.t</a></span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-create"><a href="#val-create" class="anchor"></a><code><span><span class="keyword">val</span> create : <span>unit <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'a</span> <a href="#type-t">t</a></span></span></code></div><div class="spec-doc"><p><code>create ()</code> makes a new key. Keys are expensive and should never be allocated dynamically or in a loop.</p></div></div><div class="odoc-spec"><div class="spec exception anchored" id="exception-Not_set"><a href="#exception-Not_set" class="anchor"></a><code><span><span class="keyword">exception</span> </span><span><span class="exception">Not_set</span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-get_exn"><a href="#val-get_exn" class="anchor"></a><code><span><span class="keyword">val</span> get_exn : <span><span><span class="type-var">'a</span> <a href="#type-t">t</a></span> <span class="arrow">&#45;&gt;</span></span> <span class="type-var">'a</span></span></code></div><div class="spec-doc"><p><code>get k</code> gets the value for the current task for key <code>k</code>. Must be run from inside a task running on a runner.</p><ul class="at-tags"><li class="raises"><span class="at-tag">raises</span> <a href="#exception-Not_set"><code>Not_set</code></a> <p>otherwise</p></li></ul></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-get_opt"><a href="#val-get_opt" class="anchor"></a><code><span><span class="keyword">val</span> get_opt : <span><span><span class="type-var">'a</span> <a href="#type-t">t</a></span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'a</span> option</span></span></code></div><div class="spec-doc"><p><code>get_opt k</code> gets the current task's value for key <code>k</code>, or <code>None</code> if not run from inside the task.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-get"><a href="#val-get" class="anchor"></a><code><span><span class="keyword">val</span> get : <span><span><span class="type-var">'a</span> <a href="#type-t">t</a></span> <span class="arrow">&#45;&gt;</span></span> <span><span class="label">default</span>:<span class="type-var">'a</span> <span class="arrow">&#45;&gt;</span></span> <span class="type-var">'a</span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-set"><a href="#val-set" class="anchor"></a><code><span><span class="keyword">val</span> set : <span><span><span class="type-var">'a</span> <a href="#type-t">t</a></span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'a</span> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p><code>set k v</code> sets the storage for <code>k</code> to <code>v</code>. Must be run from inside a task running on a runner.</p><ul class="at-tags"><li class="raises"><span class="at-tag">raises</span> <code>Failure</code> <p>otherwise</p></li></ul></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-with_value"><a href="#val-with_value" class="anchor"></a><code><span><span class="keyword">val</span> with_value : <span><span><span class="type-var">'a</span> <a href="#type-t">t</a></span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'a</span> <span class="arrow">&#45;&gt;</span></span> <span><span>(<span>unit <span class="arrow">&#45;&gt;</span></span> <span class="type-var">'b</span>)</span> <span class="arrow">&#45;&gt;</span></span> <span class="type-var">'b</span></span></code></div><div class="spec-doc"><p><code>with_value k v f</code> sets <code>k</code> to <code>v</code> for the duration of the call to <code>f()</code>. When <code>f()</code> returns (or fails), <code>k</code> is restored to its old value.</p></div></div><h3 id="local-hmap.t"><a href="#local-hmap.t" class="anchor"></a>Local <code>Hmap.t</code></h3><p>This requires <code>hmap</code> to be installed.</p><div class="odoc-spec"><div class="spec value anchored" id="val-k_local_hmap"><a href="#val-k_local_hmap" class="anchor"></a><code><span><span class="keyword">val</span> k_local_hmap : <span><a href="../../../hmap/Hmap/index.html#type-t">Hmap.t</a> <a href="../../../picos/Picos/Fiber/FLS/index.html#type-t">Picos.Fiber.FLS.t</a></span></span></code></div><div class="spec-doc"><p>A local hmap, inherited in children fibers</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-get_local_hmap"><a href="#val-get_local_hmap" class="anchor"></a><code><span><span class="keyword">val</span> get_local_hmap : <span>unit <span class="arrow">&#45;&gt;</span></span> <a href="../../../hmap/Hmap/index.html#type-t">Hmap.t</a></span></code></div><div class="spec-doc"><p>Access the local <code>hmap</code>, or an empty one if not set</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-set_local_hmap"><a href="#val-set_local_hmap" class="anchor"></a><code><span><span class="keyword">val</span> set_local_hmap : <span><a href="../../../hmap/Hmap/index.html#type-t">Hmap.t</a> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-update_local_hmap"><a href="#val-update_local_hmap" class="anchor"></a><code><span><span class="keyword">val</span> update_local_hmap : <span><span>(<span><a href="../../../hmap/Hmap/index.html#type-t">Hmap.t</a> <span class="arrow">&#45;&gt;</span></span> <a href="../../../hmap/Hmap/index.html#type-t">Hmap.t</a>)</span> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-get_in_local_hmap_exn"><a href="#val-get_in_local_hmap_exn" class="anchor"></a><code><span><span class="keyword">val</span> get_in_local_hmap_exn : <span><span><span class="type-var">'a</span> <a href="../../../hmap/Hmap/index.html#type-key">Hmap.key</a></span> <span class="arrow">&#45;&gt;</span></span> <span class="type-var">'a</span></span></code></div><div class="spec-doc"><ul class="at-tags"><li class="raises"><span class="at-tag">raises</span> <code>Invalid_argument</code> <p>if not present</p></li></ul></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-get_in_local_hmap_opt"><a href="#val-get_in_local_hmap_opt" class="anchor"></a><code><span><span class="keyword">val</span> get_in_local_hmap_opt : <span><span><span class="type-var">'a</span> <a href="../../../hmap/Hmap/index.html#type-key">Hmap.key</a></span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'a</span> option</span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-remove_in_local_hmap"><a href="#val-remove_in_local_hmap" class="anchor"></a><code><span><span class="keyword">val</span> remove_in_local_hmap : <span><span><span class="type-var">'a</span> <a href="../../../hmap/Hmap/index.html#type-key">Hmap.key</a></span> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p>Remove given key from the local hmap</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-set_in_local_hmap"><a href="#val-set_in_local_hmap" class="anchor"></a><code><span><span class="keyword">val</span> set_in_local_hmap : <span><span><span class="type-var">'a</span> <a href="../../../hmap/Hmap/index.html#type-key">Hmap.key</a></span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'a</span> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-with_in_local_hmap"><a href="#val-with_in_local_hmap" class="anchor"></a><code><span><span class="keyword">val</span> with_in_local_hmap : <span><span><span class="type-var">'a</span> <a href="../../../hmap/Hmap/index.html#type-key">Hmap.key</a></span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'a</span> <span class="arrow">&#45;&gt;</span></span> <span><span>(<span>unit <span class="arrow">&#45;&gt;</span></span> <span class="type-var">'b</span>)</span> <span class="arrow">&#45;&gt;</span></span> <span class="type-var">'b</span></span></code></div><div class="spec-doc"><p><code>with_in_local_hmap k v f</code> calls <code>f()</code> in a context where <code>k</code> is bound to <code>v</code> in the local hmap. Then it restores the previous binding for <code>k</code>.</p></div></div></div></body></html>
